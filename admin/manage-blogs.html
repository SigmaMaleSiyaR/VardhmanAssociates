<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Blogs - Vardhaman Associates</title>
    <!-- Favicon -->
    <link href="../img/logo.png" rel="icon" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/style.css" />
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #2c3e50;
        --secondary-color: #34495e;
        --accent-color: #3498db;
        --text-color: #2c3e50;
        --light-bg: #f8f9fa;
      }

      body {
        background-color: var(--light-bg);
        color: var(--text-color);
      }

      .navbar {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        ) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .navbar-brand {
        font-weight: 600;
        font-size: 1.5rem;
      }

      .nav-link {
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .nav-link:hover {
        transform: translateY(-2px);
      }

      .nav-link.active {
        color: var(--accent-color) !important;
        font-weight: 600;
      }

      .blog-card {
        margin-bottom: 20px;
        transition: all 0.3s ease;
        border: none;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .blog-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
      }

      .blog-image {
        height: 200px;
        object-fit: cover;
        transition: all 0.3s ease;
      }

      .blog-card:hover .blog-image {
        transform: scale(1.05);
      }

      .card-body {
        padding: 1.5rem;
      }

      .card-title {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1rem;
      }

      .card-text {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }

      .btn {
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
      }

      .btn-primary:hover {
        background-color: #2980b9;
        border-color: #2980b9;
        transform: translateY(-2px);
      }

      .btn-danger {
        background-color: #e74c3c;
        border-color: #e74c3c;
      }

      .btn-danger:hover {
        background-color: #c0392b;
        border-color: #c0392b;
        transform: translateY(-2px);
      }

      .text-muted {
        font-size: 0.85rem;
      }

      .edit-modal .modal-content {
        border-radius: 15px;
        border: none;
      }

      .modal-header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        border-radius: 15px 15px 0 0;
      }

      .modal-title {
        font-weight: 600;
      }

      .btn-close {
        filter: brightness(0) invert(1);
      }

      .ql-editor {
        min-height: 200px;
        border-radius: 8px;
      }

      .form-control {
        border-radius: 8px;
        border: 1px solid #ddd;
        padding: 0.75rem;
      }

      .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
      }

      .img-thumbnail {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .spinner-border {
        color: var(--accent-color);
      }

      .alert {
        border-radius: 10px;
        border: none;
      }

      .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
      }

      .page-title {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 3px solid var(--accent-color);
        display: inline-block;
      }

      .container {
        padding-top: 2rem;
      }

      #logoutBtn {
        margin-left: 1rem;
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      #logoutBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="fas fa-book-open me-2"></i>Vardhaman Associates
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="blog-management.html">
                <i class="fas fa-plus-circle me-1"></i>Create New Blog
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="manage-blogs.html">
                <i class="fas fa-edit me-1"></i>Manage Blogs
              </a>
            </li>
            <li class="nav-item">
              <button id="logoutBtn" class="btn btn-outline-light">
                <i class="fas fa-sign-out-alt me-1"></i>Logout
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <h2 class="page-title"><i class="fas fa-blog me-2"></i>Manage Blogs</h2>
      <div class="row" id="blogList">
        <!-- Blogs will be loaded here -->
      </div>
    </div>

    <!-- Edit Blog Modal -->
    <div class="modal fade edit-modal" id="editBlogModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-edit me-2"></i>Edit Blog
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editBlogForm">
              <div class="mb-3">
                <label for="editTitle" class="form-label">Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="editTitle"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editDescription" class="form-label"
                  >Short Description</label
                >
                <textarea
                  class="form-control"
                  id="editDescription"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="editContent" class="form-label">Content</label>
                <div id="editEditor"></div>
              </div>
              <div class="mb-3">
                <label for="editImage" class="form-label">Featured Image</label>
                <input
                  type="file"
                  class="form-control"
                  id="editImage"
                  accept="image/*"
                />
                <div id="currentImage" class="mt-2"></div>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Quill Editor -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- Firebase SDK -->
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js"
    ></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
      import {
        getAuth,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        deleteDoc,
        doc,
        updateDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAV6RSeZ1j5krYodWKIXGNJE1sY_l9pvh8",
        authDomain: "vardhamanassociates-861f9.firebaseapp.com",
        projectId: "vardhamanassociates-861f9",
        storageBucket: "vardhamanassociates-861f9.appspot.com",
        messagingSenderId: "322122751719",
        appId: "1:322122751719:web:9f4ae6936a8bf144244c42",
        measurementId: "G-Y06T3Q22YD",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Initialize Quill editor
      const quill = new Quill("#editEditor", {
        theme: "snow",
        modules: {
          toolbar: {
            container: [
              ["bold", "italic", "underline", "strike"],
              ["blockquote", "code-block"],
              [{ header: 1 }, { header: 2 }],
              [{ list: "ordered" }, { list: "bullet" }],
              [{ script: "sub" }, { script: "super" }],
              [{ indent: "-1" }, { indent: "+1" }],
              [{ direction: "rtl" }],
              [{ size: ["small", false, "large", "huge"] }],
              [{ header: [1, 2, 3, 4, 5, 6, false] }],
              [{ color: [] }, { background: [] }],
              [{ font: [] }],
              [{ align: [] }],
              ["clean"],
              ["link", "image"],
            ],
            handlers: {
              image: function () {
                const input = document.createElement("input");
                input.setAttribute("type", "file");
                input.setAttribute("accept", "image/*");
                input.click();

                input.onchange = async () => {
                  const file = input.files[0];
                  if (file) {
                    try {
                      const uploadResult = await uploadImageToImageKit(
                        file,
                        false
                      );
                      const range = quill.getSelection(true);
                      quill.insertEmbed(range.index, "image", uploadResult.url);
                    } catch (error) {
                      console.error("Error uploading image:", error);
                      alert("Failed to upload image. Please try again.");
                    }
                  }
                };
              },
            },
          },
        },
      });

      // Check authentication state
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "index.html";
        }
      });

      // Logout functionality
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          try {
            await signOut(auth);
            window.location.href = "index.html";
          } catch (error) {
            console.error("Error signing out:", error);
          }
        });

      // Function to upload image to ImageKit
      async function uploadImageToImageKit(file, isThumbnail = false) {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: "https://vablogs.vercel.app/api/auth",
            method: "GET",
            dataType: "json",
            success: function (authData) {
              const formData = new FormData();
              formData.append("file", file);
              formData.append("fileName", `${Date.now()}_${file.name}`);
              formData.append("token", authData.token);
              formData.append("signature", authData.signature);
              formData.append("expire", authData.expire);
              formData.append(
                "publicKey",
                "public_C5juPBxFMNI+aIo/PkxOrNXPtFM="
              );
              formData.append(
                "folder",
                isThumbnail ? "/blog-thumbnails" : "/blog-content"
              );

              $.ajax({
                url: "https://upload.imagekit.io/api/v1/files/upload",
                method: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                  Accept: "application/json",
                },
                success: function (response) {
                  resolve(response);
                },
                error: function (xhr, status, error) {
                  reject(new Error(xhr.responseText || "Upload failed"));
                },
              });
            },
            error: function (xhr, status, error) {
              reject(new Error("Failed to get authentication token"));
            },
          });
        });
      }

      // Function to delete image from ImageKit
      async function deleteImageFromImageKit(fileId) {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: "https://vablogs.vercel.app/api/auth",
            method: "GET",
            dataType: "json",
            success: function (authData) {
              $.ajax({
                url: `https://api.imagekit.io/v1/files/${fileId}`,
                method: "DELETE",
                headers: {
                  Authorization: `Bearer ${authData.token}`,
                  Accept: "application/json",
                },
                success: function (response) {
                  resolve(response);
                },
                error: function (xhr, status, error) {
                  reject(new Error(xhr.responseText || "Delete failed"));
                },
              });
            },
            error: function (xhr, status, error) {
              reject(new Error("Failed to get authentication token"));
            },
          });
        });
      }

      // Load and display blogs
      async function loadBlogs() {
        const blogList = document.getElementById("blogList");
        blogList.innerHTML =
          '<div class="col-12 text-center"><div class="spinner-border" role="status"></div></div>';

        try {
          const querySnapshot = await getDocs(collection(db, "blogs"));
          blogList.innerHTML = "";

          if (querySnapshot.empty) {
            blogList.innerHTML = `
                        <div class="col-12 text-center">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>No blogs found.
                            </div>
                        </div>`;
            return;
          }

          querySnapshot.forEach((doc) => {
            const blog = doc.data();
            const blogElement = document.createElement("div");
            blogElement.className = "col-md-6 col-lg-4";
            blogElement.innerHTML = `
                        <div class="blog-card">
                            <img src="${
                              blog.imageUrl
                            }" class="blog-image" alt="${blog.title}">
                            <div class="card-body">
                                <h5 class="card-title">${blog.title}</h5>
                                <p class="card-text">${blog.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="far fa-calendar-alt me-1"></i>
                                        ${new Date(
                                          blog.createdAt
                                        ).toLocaleDateString()}
                                    </small>
                                    <div>
                                        <button class="btn btn-primary btn-sm me-2" onclick="editBlog('${
                                          doc.id
                                        }')">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteBlog('${
                                          doc.id
                                        }', '${blog.imageUrl}')">
                                            <i class="fas fa-trash-alt me-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            blogList.appendChild(blogElement);
          });
        } catch (error) {
          console.error("Error loading blogs:", error);
          blogList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error loading blogs. Please try again.
                        </div>
                    </div>`;
        }
      }

      // Edit blog
      window.editBlog = async (blogId) => {
        try {
          const docRef = doc(db, "blogs", blogId);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const blog = docSnap.data();

            // Populate form
            document.getElementById("editTitle").value = blog.title;
            document.getElementById("editDescription").value = blog.description;
            quill.root.innerHTML = blog.content;

            // Show current image
            const currentImage = document.getElementById("currentImage");
            currentImage.innerHTML = `
                        <p>Current Image:</p>
                        <img src="${blog.imageUrl}" class="img-thumbnail" style="max-height: 200px;">
                    `;

            // Store blog ID for update
            document.getElementById("editBlogForm").dataset.blogId = blogId;

            // Show modal
            const modal = new bootstrap.Modal(
              document.getElementById("editBlogModal")
            );
            modal.show();
          }
        } catch (error) {
          console.error("Error loading blog:", error);
          alert("Error loading blog. Please try again.");
        }
      };

      // Handle edit form submission
      document
        .getElementById("editBlogForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const submitButton = e.target.querySelector('button[type="submit"]');
          submitButton.disabled = true;
          submitButton.textContent = "Saving...";

          try {
            const blogId = e.target.dataset.blogId;
            const title = document.getElementById("editTitle").value;
            const description =
              document.getElementById("editDescription").value;
            const content = quill.root.innerHTML;
            const imageFile = document.getElementById("editImage").files[0];

            const updateData = {
              title,
              description,
              content,
            };

            // If new image is uploaded, update it
            if (imageFile) {
              const uploadResult = await uploadImageToImageKit(imageFile, true);
              updateData.imageUrl = uploadResult.url;
              updateData.imageFileId = uploadResult.fileId; // <-- store fileId
            }

            // Update Firestore
            await updateDoc(doc(db, "blogs", blogId), updateData);

            // Close modal and refresh
            bootstrap.Modal.getInstance(
              document.getElementById("editBlogModal")
            ).hide();
            loadBlogs();
            alert("Blog updated successfully!");
          } catch (error) {
            console.error("Error updating blog:", error);
            alert(`Error updating blog: ${error.message}`);
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Save Changes";
          }
        });

      // Delete blog
      window.deleteBlog = async (blogId, imageUrl) => {
        if (
          confirm(
            "Are you sure you want to delete this blog? This action cannot be undone."
          )
        ) {
          try {
            // Fetch the blog document to get the fileId
            const docRef = doc(db, "blogs", blogId);
            const docSnap = await getDoc(docRef);
            let fileId = null;
            if (docSnap.exists()) {
              const blogData = docSnap.data();
              fileId = blogData.imageFileId || null;
            }

            // Delete from ImageKit if fileId exists
            if (fileId) {
              await deleteImageFromImageKit(fileId);
            }

            // Delete from Firestore
            await deleteDoc(doc(db, "blogs", blogId));

            loadBlogs();
            alert("Blog deleted successfully!");
          } catch (error) {
            console.error("Error deleting blog:", error);
            alert("Error deleting blog. Please try again.");
          }
        }
      };

      // Load blogs on page load
      loadBlogs();
    </script>
  </body>
</html>
